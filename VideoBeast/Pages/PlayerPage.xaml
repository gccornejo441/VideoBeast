<Page
    x:Class="VideoBeast.Pages.PlayerPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:ct="using:CommunityToolkit.WinUI.Controls"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

	<Page.Resources>

		<!-- ? ListViewItem style used by the playlist -->
		<Style x:Key="PlaylistListViewItemStyle" TargetType="ListViewItem">
			<Setter Property="Padding" Value="0" />
			<Setter Property="Margin" Value="0,2" />
			<Setter Property="HorizontalContentAlignment" Value="Stretch" />
			<Setter Property="Background" Value="Transparent" />
			<Setter Property="BorderThickness" Value="1" />
			<Setter Property="BorderBrush" Value="Transparent" />

			<Setter Property="Template">
				<Setter.Value>
					<ControlTemplate TargetType="ListViewItem">
						<Grid>
							<Border x:Name="RowRoot"
                                    Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}"
                                    CornerRadius="10">
								<ContentPresenter
                                    Content="{TemplateBinding Content}"
                                    ContentTemplate="{TemplateBinding ContentTemplate}"
                                    HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                    VerticalAlignment="{TemplateBinding VerticalContentAlignment}" />
							</Border>

							<!-- WinUI: use VisualStateManager, not Triggers -->
							<VisualStateManager.VisualStateGroups>

								<VisualStateGroup x:Name="CommonStates">
									<VisualState x:Name="Normal" />

									<VisualState x:Name="PointerOver">
										<VisualState.Setters>
											<Setter Target="RowRoot.Background" Value="#1AFFFFFF" />
											<Setter Target="RowRoot.BorderBrush" Value="#33FFFFFF" />
										</VisualState.Setters>
									</VisualState>

									<VisualState x:Name="Pressed">
										<VisualState.Setters>
											<Setter Target="RowRoot.Background" Value="#22FFFFFF" />
											<Setter Target="RowRoot.BorderBrush" Value="#55FFFFFF" />
										</VisualState.Setters>
									</VisualState>

									<VisualState x:Name="Disabled">
										<VisualState.Setters>
											<Setter Target="RowRoot.Opacity" Value="0.5" />
										</VisualState.Setters>
									</VisualState>
								</VisualStateGroup>

								<VisualStateGroup x:Name="SelectionStates">
									<VisualState x:Name="Unselected" />

									<VisualState x:Name="Selected">
										<VisualState.Setters>
											<Setter Target="RowRoot.Background" Value="#222222" />
											<Setter Target="RowRoot.BorderBrush" Value="#666666" />
										</VisualState.Setters>
									</VisualState>

									<VisualState x:Name="SelectedPointerOver">
										<VisualState.Setters>
											<Setter Target="RowRoot.Background" Value="#222222" />
											<Setter Target="RowRoot.BorderBrush" Value="#777777" />
										</VisualState.Setters>
									</VisualState>
								</VisualStateGroup>

							</VisualStateManager.VisualStateGroups>
						</Grid>
					</ControlTemplate>
				</Setter.Value>
			</Setter>
		</Style>

		<!-- Shared context menu for playlist items -->
		<MenuFlyout x:Key="PlaylistFileFlyout">
			<MenuFlyoutItem Text="Play" Click="Playlist_Play_Click">
				<MenuFlyoutItem.Icon>
					<SymbolIcon Symbol="Play" />
				</MenuFlyoutItem.Icon>
			</MenuFlyoutItem>

			<MenuFlyoutItem Text="Show in folder" Click="Playlist_ShowInFolder_Click">
				<MenuFlyoutItem.Icon>
					<SymbolIcon Symbol="Find" />
				</MenuFlyoutItem.Icon>
			</MenuFlyoutItem>

			<MenuFlyoutSeparator />

			<MenuFlyoutItem Text="Copy path" Click="Playlist_CopyPath_Click">
				<MenuFlyoutItem.Icon>
					<SymbolIcon Symbol="Copy" />
				</MenuFlyoutItem.Icon>
			</MenuFlyoutItem>

			<MenuFlyoutItem Text="Rename" Click="Playlist_Rename_Click">
				<MenuFlyoutItem.Icon>
					<SymbolIcon Symbol="Edit" />
				</MenuFlyoutItem.Icon>
			</MenuFlyoutItem>

			<MenuFlyoutSeparator />

			<MenuFlyoutItem Text="Delete" Click="Playlist_Delete_Click">
				<MenuFlyoutItem.Icon>
					<SymbolIcon Symbol="Delete" />
				</MenuFlyoutItem.Icon>
			</MenuFlyoutItem>
		</MenuFlyout>
	</Page.Resources>

	<Grid
        x:Name="LayoutRoot"
        PointerMoved="PlayerArea_PointerMoved"
        PointerPressed="PlayerArea_PointerPressed"
        Tapped="PlayerArea_Tapped">

		<Border
            x:Name="CardShell"
            Margin="5"
            Padding="0"
            Background="Transparent"
            BorderBrush="Transparent"
            BorderThickness="0"
            CornerRadius="0">

			<Grid RowSpacing="10">
				<Grid.RowDefinitions>
					<RowDefinition Height="*" />
					<RowDefinition Height="Auto" />
				</Grid.RowDefinitions>

				<!-- Player + Playlist split -->
				<Grid Grid.Row="0" ColumnSpacing="10">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*" />
						<ColumnDefinition Width="Auto" />
						<ColumnDefinition Width="360" />
					</Grid.ColumnDefinitions>

					<!-- PLAYER COLUMN -->
					<Grid Grid.Column="0">
						<Border
                            x:Name="PlayerHost"
                            Background="#FF000000"
                            BorderBrush="{StaticResource Stroke}"
                            BorderThickness="1"
                            CornerRadius="16">

							<Grid
                                x:Name="PlayerArea"
                                Margin="0"
                                Padding="0"
                                PointerMoved="PlayerArea_PointerMoved"
                                PointerPressed="PlayerArea_PointerPressed"
                                Tapped="PlayerArea_Tapped">

								<MediaPlayerElement
                                    x:Name="Player"
                                    HorizontalAlignment="Stretch"
                                    VerticalAlignment="Stretch"
                                    AreTransportControlsEnabled="False"
                                    AutoPlay="False"
                                    Background="Black"
                                    Tapped="Player_Tapped"
                                    Stretch="UniformToFill" />

								<!-- ControlBar -->
								<Border
                                    x:Name="ControlBar"
                                    Margin="12"
                                    Padding="10"
                                    VerticalAlignment="Bottom"
                                    Background="#AA111111"
                                    BorderBrush="{StaticResource Stroke}"
                                    BorderThickness="1"
                                    CornerRadius="12"
                                    Opacity="1"
                                    PointerEntered="ControlBar_PointerEntered"
                                    PointerExited="ControlBar_PointerExited">

									<StackPanel Spacing="10">

										<!-- Seek row -->
										<Grid ColumnSpacing="10">
											<Grid.ColumnDefinitions>
												<ColumnDefinition Width="Auto" />
												<ColumnDefinition Width="*" />
												<ColumnDefinition Width="Auto" />
											</Grid.ColumnDefinitions>

											<TextBlock
                                                x:Name="PositionText"
                                                Grid.Column="0"
                                                FontSize="12"
                                                Foreground="White"
                                                Text="0:00" />

											<Slider
                                                x:Name="SeekSlider"
                                                Grid.Column="1"
                                                Maximum="1"
                                                Minimum="0"
                                                SnapsTo="StepValues"
                                                StepFrequency="0.1"
                                                ValueChanged="SeekSlider_ValueChanged"
                                                Value="0" />

											<TextBlock
                                                x:Name="DurationText"
                                                Grid.Column="2"
                                                FontSize="12"
                                                Foreground="White"
                                                Text="0:00" />
										</Grid>

										<!-- Buttons row -->
										<Grid ColumnSpacing="12">
											<Grid.ColumnDefinitions>
												<ColumnDefinition Width="Auto" />
												<ColumnDefinition Width="Auto" />
												<ColumnDefinition Width="Auto" />
												<ColumnDefinition Width="Auto" />
												<ColumnDefinition Width="Auto" />
												<ColumnDefinition Width="*" />
												<ColumnDefinition Width="Auto" />
												<ColumnDefinition Width="Auto" />
												<ColumnDefinition Width="Auto" />
											</Grid.ColumnDefinitions>

											<Button
                                                x:Name="PlayPauseButton"
                                                Grid.Column="0"
                                                Click="PlayPause_Click">
												<StackPanel Orientation="Horizontal" Spacing="8">
													<SymbolIcon x:Name="PlayPauseIcon" Symbol="Play" />
													<TextBlock
                                                        x:Name="PlayPauseText"
                                                        Foreground="White"
                                                        Text="Play" />
												</StackPanel>
											</Button>

											<Button Grid.Column="1" Click="Stop_Click">
												<SymbolIcon Symbol="Stop" />
											</Button>

											<ToggleButton
                                                x:Name="LoopToggle"
                                                Grid.Column="2"
                                                Click="LoopToggle_Click"
                                                ToolTipService.ToolTip="Loop">
												<SymbolIcon Symbol="RepeatAll" />
											</ToggleButton>

											<ToggleButton
                                                x:Name="MuteToggle"
                                                Grid.Column="3"
                                                Click="MuteToggle_Click"
                                                ToolTipService.ToolTip="Mute">
												<SymbolIcon x:Name="MuteIcon" Symbol="Volume" />
											</ToggleButton>

											<StackPanel
                                                Grid.Column="4"
                                                VerticalAlignment="Center"
                                                Orientation="Horizontal"
                                                Spacing="8">
												<TextBlock
                                                    FontSize="12"
                                                    Foreground="White"
                                                    Text="Vol" />
												<Slider
                                                    x:Name="VolumeSlider"
                                                    Width="160"
                                                    LargeChange="10"
                                                    Maximum="100"
                                                    Minimum="0"
                                                    SmallChange="1"
                                                    SnapsTo="StepValues"
                                                    StepFrequency="1"
                                                    ValueChanged="VolumeSlider_ValueChanged" />
											</StackPanel>

											<Grid Grid.Column="5" />

											<ComboBox
                                                x:Name="RateCombo"
                                                Grid.Column="6"
                                                Width="110"
                                                SelectionChanged="RateCombo_SelectionChanged">
												<ComboBoxItem Content="0.5x" Tag="0.5" />
												<ComboBoxItem Content="1.0x" IsSelected="True" Tag="1.0" />
												<ComboBoxItem Content="1.25x" Tag="1.25" />
												<ComboBoxItem Content="1.5x" Tag="1.5" />
												<ComboBoxItem Content="2.0x" Tag="2.0" />
											</ComboBox>

											<!-- Toggle playlist -->
											<ToggleButton
                                                x:Name="PlaylistToggle"
                                                Grid.Column="7"
                                                Click="PlaylistToggle_Click"
                                                ToolTipService.ToolTip="Playlist">
												<SymbolIcon Symbol="Bullets" />
											</ToggleButton>

											<ToggleButton
                                                x:Name="FullWindowToggle"
                                                Grid.Column="8"
                                                Click="FullWindowToggle_Click"
                                                ToolTipService.ToolTip="Full screen">
												<SymbolIcon Symbol="FullScreen" />
											</ToggleButton>
										</Grid>
									</StackPanel>
								</Border>
							</Grid>
						</Border>

						<!-- Empty state -->
						<Border
                            x:Name="EmptyState"
                            Background="{StaticResource Card2}"
                            BorderBrush="{StaticResource Stroke}"
                            BorderThickness="1"
                            CornerRadius="16"
                            Opacity="0.98"
                            Visibility="Collapsed">
							<StackPanel
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                Spacing="10">
								<TextBlock
                                    HorizontalAlignment="Center"
                                    FontSize="22"
                                    FontWeight="SemiBold"
                                    Text="Pick a folder, then import MP4s" />
								<TextBlock
                                    HorizontalAlignment="Center"
                                    Foreground="{StaticResource TextFaint}"
                                    Text="Select a folder in the left pane. Videos will appear in the playlist." />
							</StackPanel>
						</Border>
					</Grid>

					<!-- SPLITTER -->
					<ct:GridSplitter
                        x:Name="PlaylistSplitter"
                        Grid.Column="1"
                        Width="6"
                        HorizontalAlignment="Stretch"
                        VerticalAlignment="Stretch"
                        Background="Transparent" />

					<!-- PLAYLIST COLUMN -->
					<Border
                        x:Name="PlaylistPanel"
                        Grid.Column="2"
                        Background="{StaticResource Card2}"
                        BorderBrush="{StaticResource Stroke}"
                        BorderThickness="1"
                        CornerRadius="16"
                        Padding="12">

						<Grid RowSpacing="10">
							<Grid.RowDefinitions>
								<RowDefinition Height="Auto" />
								<RowDefinition Height="Auto" />
								<RowDefinition Height="*" />
							</Grid.RowDefinitions>

							<Grid Grid.Row="0" ColumnSpacing="8">
								<Grid.ColumnDefinitions>
									<ColumnDefinition Width="*" />
									<ColumnDefinition Width="Auto" />
								</Grid.ColumnDefinitions>

								<TextBlock
                                    x:Name="PlaylistTitle"
                                    FontSize="16"
                                    FontWeight="SemiBold"
                                    Text="Videos" />

								<Button Grid.Column="1" Click="PlaylistRefresh_Click" ToolTipService.ToolTip="Refresh folder">
									<SymbolIcon Symbol="Refresh" />
								</Button>
							</Grid>

							<TextBox
                                x:Name="PlaylistFilterBox"
                                Grid.Row="1"
                                PlaceholderText="Filter videos…"
                                TextChanged="PlaylistFilterBox_TextChanged" />

							<ListView
                                x:Name="FilesList"
                                Grid.Row="2"
                                IsItemClickEnabled="True"
                                ItemClick="FilesList_ItemClick"
                                IncrementalLoadingTrigger="Edge"
                                IncrementalLoadingThreshold="2">

								<!-- ? Merge your base style + context flyout into ONE style -->
								<ListView.ItemContainerStyle>
									<Style TargetType="ListViewItem"
                                           BasedOn="{StaticResource PlaylistListViewItemStyle}">
										<Setter Property="ContextFlyout" Value="{StaticResource PlaylistFileFlyout}" />
									</Style>
								</ListView.ItemContainerStyle>

								<ListView.ItemTemplate>
									<DataTemplate>
										<Grid Padding="8" ColumnSpacing="10">
											<Grid.ColumnDefinitions>
												<ColumnDefinition Width="Auto" />
												<ColumnDefinition Width="*" />
											</Grid.ColumnDefinitions>

											<SymbolIcon Grid.Column="0" Symbol="Video" />

											<StackPanel Grid.Column="1" Spacing="2">
												<TextBlock
                                                    Text="{Binding Name}"
                                                    TextTrimming="CharacterEllipsis" />
												<TextBlock
                                                    FontSize="12"
                                                    Opacity="0.7"
                                                    Text="{Binding FileType}" />
											</StackPanel>
										</Grid>
									</DataTemplate>
								</ListView.ItemTemplate>
							</ListView>
						</Grid>
					</Border>
				</Grid>
			</Grid>
		</Border>

		<VisualStateManager.VisualStateGroups>

			<!-- ControlBar fade -->
			<VisualStateGroup x:Name="ControlsStates">
				<VisualState x:Name="ControlsVisible">
					<Storyboard>
						<DoubleAnimation
                            Storyboard.TargetName="ControlBar"
                            Storyboard.TargetProperty="Opacity"
                            To="1"
                            Duration="0:0:0.15" />
					</Storyboard>
				</VisualState>

				<VisualState x:Name="ControlsHidden">
					<Storyboard>
						<DoubleAnimation
                            Storyboard.TargetName="ControlBar"
                            Storyboard.TargetProperty="Opacity"
                            To="0"
                            Duration="0:0:0.20" />
					</Storyboard>
				</VisualState>
			</VisualStateGroup>

			<!-- Fill-the-window mode -->
			<VisualStateGroup x:Name="PlayerWindowStates">
				<VisualState x:Name="PlayerNormal" />

				<VisualState x:Name="PlayerFullWindow">
					<VisualState.Setters>
						<Setter Target="CardShell.Margin" Value="0" />
						<Setter Target="CardShell.Padding" Value="0" />
						<Setter Target="CardShell.CornerRadius" Value="0" />
						<Setter Target="CardShell.BorderThickness" Value="0" />

						<Setter Target="PlayerHost.CornerRadius" Value="0" />
						<Setter Target="PlayerHost.BorderThickness" Value="0" />

						<Setter Target="ControlBar.Margin" Value="16" />

						<!-- Hide playlist in FullWindow -->
						<Setter Target="PlaylistPanel.Visibility" Value="Collapsed" />
						<Setter Target="PlaylistSplitter.Visibility" Value="Collapsed" />
					</VisualState.Setters>
				</VisualState>
			</VisualStateGroup>

		</VisualStateManager.VisualStateGroups>
	</Grid>
</Page>
